<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
	<title>dom32</title>
	<style>
		body {
			margin: 0;
		}

		#container {
			position: absolute;
			left: 30px;
			top: 40px;
			border: 1px solid #ff6700;
		}
		.box {
			display: inline-block;
			width: 100px;
			height: 100px;
			margin: 10px;
			background-color: gray;
		}

		.box.active{
			background-color: skyblue;
		}

		.select-box {
			position: absolute;
			left: 0;
			top: 0;
			width: 0;
			height: 0;
			background-color: rgba(0,0,0,.4);
			border: 2px dotted #f44;
			z-index: 10;
			opacity: 0;
		}
	</style>
</head>
<body>
	<div class="select-box"></div>
	<script>
		//=> 1
		let length = 20;
		for (let i = 0; i < length; i += 1) {
			let $div = document.createElement('div');
			$div.className = 'box';
			document.body.append($div);
		}

		//=> 2
		let timer = null;
		let moveFlag = false;
		let allBox = document.getElementsByClassName('box');
		function down(e){
			e = e || window.event;
			let target = e.target;

			//=> 记录起始位置
			let scrollLeft = document.body.scrollLeft || document.documentElement.scrollLeft;
			let scrollTop = document.body.scrollTop || document.documentElement.scrollTop;
 			this.startX = e.clientX + scrollLeft;
 			this.startY = e.clientY + scrollTop;

			if (target.className.indexOf('box') > -1) {
				timer = setTimeout(function(){
					target.className = 'box active';
					document.addEventListener('mousemove', move);
					document.addEventListener('touchmove', move);
					clearTimeout(timer);
				}, 350);
			} else {
				Array.prototype.slice.call(allBox).forEach(item =>{
					item.className = 'box';
				});
			}
			document.addEventListener('mouseup', up);
			document.addEventListener('touchend', up);
			
		}
		function up(){
			console.log({moveFlag});
			timer ? clearTimeout(timer) : null;
			moveFlag ? setSelectBox(this) : null;
			document.removeEventListener('mouseup', up);
			document.removeEventListener('touchend', up);
			document.removeEventListener('mousemove', move);
			document.removeEventListener('touchmove', move);
			resetBoxAttribute(this);
		}
		document.addEventListener('mousedown', down);
		document.addEventListener('touchstart', down);

		//=> 3
		function move(e){
      moveFlag = true;
			e = e || window.event;
			let scrollLeft = document.body.scrollLeft || document.documentElement.scrollLeft;
			let scrollTop = document.body.scrollTop || document.documentElement.scrollTop;
			this.curX = e.clientX + scrollLeft;
			this.curY = e.clientY + scrollTop;
			this.moveX = this.curX - this.startX;
			this.moveY = this.curY - this.startY;
			let width = Math.abs(this.moveX);
			let height = Math.abs(this.moveY);
			let left = this.moveX >= 0 ? this.startX : (this.startX + this.moveX);
			let top = this.moveY >= 0 ? this.startY : (this.startY + this.moveY); 
			setBoxAttribute(left, top, width, height, 1);

		}

		//=> 阴影选区部分
		let selectBox = document.getElementsByClassName('select-box')[0];
		function setBoxAttribute(left, top, width, height, opacity){ //=> 设置选区属性
			selectBox.style.left = left + 'px';
			selectBox.style.top = top + 'px';
			selectBox.style.width = width + 'px';
			selectBox.style.height = height + 'px';
			selectBox.style.opacity = opacity;
		}

		function resetBoxAttribute(_this){ //=> 重置选区以及数据
			selectBox.style.left = 0;
			selectBox.style.top = 0;
			selectBox.style.width = 0;
			selectBox.style.height = 0;
			selectBox.style.opacity = 0;
			moveFlag = false;
			_this.startX = null;
			_this.startY = null;
			_this.curX = null;
			_this.curY = null;
			_this.moveX = null;
			_this.moveY = null;
		}

		function setSelectBox(_this){ //=> 选区框选
			let startX = _this.startX;
			let endX = _this.curX;
			let startY = _this.startY;
			let endY = _this.curY;
			Array.prototype.slice.call(allBox).forEach(item =>{
				let offsetX = item.offsetLeft;
				let offsetY = item.offsetTop;
				let a,b,c,d,e,f,XSelected,YSelected;
				if (startX >= endX) {
					[startX, endX] = [endX, startX]
				} 
				if (startY >= endY) {
					[startY, endY] = [endY, startY]
				} 

				a = startX >= offsetX && startX <= offsetX + 100;
				if (a) {
					XSelected = true;
				} else {
					b = endX >= offsetX && endX <= offsetX + 100;
					if (b) {
						XSelected = true;
					} else {
						c = offsetX >= startX && offsetX + 100 <= endX;
						if (c) {
							XSelected = true;
						}
					}
				}

				d = startY >= offsetY && startY <= offsetY + 100;
				if (d) {
					YSelected = true;
				} else {
					e = endY >= offsetY && endY <= offsetY + 100;
					if (e) {
						YSelected = true;
					} else {
						f = offsetY >= startY && offsetY + 100 <= endY;
						if (f) {
							YSelected = true;
						}
					}
				}

				if (XSelected && YSelected) {
					item.className = 'box active';
				}
			});
			moveFlag = false;
		}
	</script>
</body>
</html>